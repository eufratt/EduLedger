generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int             @id @default(autoincrement())
  name              String
  email             String          @unique
  password          String
  role              Role            @default(CIVITAS)
  civitasType       CivitasType?
  isActive          Boolean         @default(true)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  requestsApproved  BudgetRequest[] @relation("RequestApprovedBy")
  requestsSubmitted BudgetRequest[] @relation("RequestSubmittedBy")
  ledgerRecorded    LedgerEntry[]   @relation("LedgerRecordedBy")
  rkabsApproved     Rkab[]          @relation("RkabApprovedBy")
  rkabsCreated      Rkab[]          @relation("RkabCreatedBy")
  requestsDisbursed BudgetRequest[] @relation("RequestDisbursedBy")
}

model FundingSource {
  id            Int           @id @default(autoincrement())
  name          String
  agency        String?
  createdAt     DateTime      @default(now())
  ledgerEntries LedgerEntry[]
}

model BudgetRequest {
  id              Int       @id @default(autoincrement())
  title           String
  description     String?
  amountRequested Int
  neededBy        DateTime?

  status        BudgetRequestStatus @default(SUBMITTED)
  submittedById Int
  submittedAt   DateTime?
  approvedById  Int?
  approvedAt    DateTime?
  approvalNote  String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  approvedBy  User?     @relation("RequestApprovedBy", fields: [approvedById], references: [id])
  submittedBy User      @relation("RequestSubmittedBy", fields: [submittedById], references: [id])
  rkabItem    RkabItem?

  disbursedAt   DateTime?
  disbursedById Int?
  disbursedBy   User?     @relation("RequestDisbursedBy", fields: [disbursedById], references: [id])

  proofs RequestProof[]

  @@index([status])
  @@index([submittedById])
  @@index([approvedById])
}

model Rkab {
  id           Int        @id @default(autoincrement())
  code         String     @unique
  fiscalYear   Int
  status       RkabStatus @default(DRAFT)
  createdById  Int
  submittedAt  DateTime?
  approvedById Int?
  approvedAt   DateTime?
  approvalNote String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  approvedBy   User?      @relation("RkabApprovedBy", fields: [approvedById], references: [id])
  createdBy    User       @relation("RkabCreatedBy", fields: [createdById], references: [id])
  items        RkabItem[]

  @@index([fiscalYear])
  @@index([status])
  @@index([createdById])
  @@index([approvedById])
}

model RkabItem {
  id              Int           @id @default(autoincrement())
  rkabId          Int
  budgetRequestId Int           @unique
  amountAllocated Int
  usedAmount      Int           @default(0)
  note            String?
  createdAt       DateTime      @default(now())
  expenses        LedgerEntry[]
  budgetRequest   BudgetRequest @relation(fields: [budgetRequestId], references: [id])
  rkab            Rkab          @relation(fields: [rkabId], references: [id])

  @@index([rkabId])
}

model LedgerEntry {
  id              Int          @id @default(autoincrement())
  type            CategoryType
  amount          Int
  date            DateTime
  description     String?
  fundingSourceId Int?
  rkabItemId      Int?
  recordedById    Int
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  fundingSource FundingSource? @relation(fields: [fundingSourceId], references: [id])
  recordedBy    User          @relation("LedgerRecordedBy", fields: [recordedById], references: [id])
  rkabItem      RkabItem?     @relation(fields: [rkabItemId], references: [id])

  @@index([date])
  @@index([type])
  @@index([fundingSourceId])
  @@index([rkabItemId])
  @@index([recordedById])
}

enum Role {
  CIVITAS
  BENDAHARA
  KEPSEK
}

enum CivitasType {
  PEGAWAI
  GURU
}

enum CategoryType {
  INCOME
  EXPENSE
}

enum BudgetRequestStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  DISBURSED // Dicairkan oleh bendahara
  COMPLETED // (opsional) setelah bukti diupload
  CANCELLED
}

enum RkabStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

model RequestProof {
  id         Int      @id @default(autoincrement())
  requestId  Int
  fileUrl    String
  fileName   String
  mimeType   String
  size       Int
  uploadedAt DateTime @default(now())

  request BudgetRequest @relation(fields: [requestId], references: [id])

  @@index([requestId])
}
